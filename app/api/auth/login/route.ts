export const runtime = 'nodejs';
import { NextRequest,NextResponse } from 'next/server';import { db } from '@/db/client';import { users } from '@/db/schema';import { eq } from 'drizzle-orm';import { verifyPassword } from '@/lib/crypto';import { createSession } from '@/lib/auth';import { rateLimit } from '@/lib/rate-limit';export async function POST(req:NextRequest){const ip=req.headers.get('x-forwarded-for')?.split(',')[0]?.trim()||'0.0.0.0';if(!rateLimit(`login:${ip}`,{capacity:5,refillPerSec:0.5}))return NextResponse.json({message:'Too many attempts'},{status:429});const {email,password}=await req.json();const u=(await db.select().from(users).where(eq(users.email,email)).limit(1))[0];if(!u)return NextResponse.json({message:'Invalid credentials'},{status:401});const ok=await verifyPassword(password,u.passwordHash);if(!ok)return NextResponse.json({message:'Invalid credentials'},{status:401});await createSession({id:u.id,role:u.role,email:u.email});return NextResponse.json({ok:true});}
