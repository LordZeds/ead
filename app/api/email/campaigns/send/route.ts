export const runtime = 'nodejs';
import { NextRequest,NextResponse } from 'next/server';import { db } from '@/db/client';import { emailCampaigns, users } from '@/db/schema';import { eq } from 'drizzle-orm';import { sendMail } from '@/lib/mail';export async function POST(req:NextRequest){const { id } = await req.json();const camp=(await db.select().from(emailCampaigns).where(eq(emailCampaigns.id,id)).limit(1))[0];if(!camp)return NextResponse.json({message:'Not found'},{status:404});const recipients=await db.select({email:users.email}).from(users).limit(1000);for(const r of recipients){await sendMail(r.email,camp.subject,camp.html);}await db.update(emailCampaigns).set({status:'sent'}).where(eq(emailCampaigns.id,id));return NextResponse.json({ok:true});}
