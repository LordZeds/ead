export const runtime = 'nodejs';
import { NextRequest,NextResponse } from 'next/server';import { readSession } from '@/lib/auth';import { db } from '@/db/client';import { users } from '@/db/schema';import { eq } from 'drizzle-orm';import { hashPassword,verifyPassword } from '@/lib/crypto';export async function PUT(req:NextRequest){const s=await readSession();if(!s)return NextResponse.json({message:'Unauthorized'},{status:401});const {currentPassword,newPassword}=await req.json();const u=(await db.select().from(users).where(eq(users.id,s.sub)).limit(1))[0];if(!u)return NextResponse.json({message:'Unauthorized'},{status:401});const ok=await verifyPassword(currentPassword,u.passwordHash);if(!ok)return NextResponse.json({message:'Invalid credentials'},{status:401});await db.update(users).set({passwordHash:await hashPassword(newPassword),updatedAt:new Date()}).where(eq(users.id,s.sub));return NextResponse.json({ok:true});}
